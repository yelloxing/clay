<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="shortcut icon" href="../../doc/images/clay.png" type="image/x-png">
    <script src="../libs/clay.js"></script>
    <script src="../../data/normal/data.force.json.js"></script>
    <title>力布局</title>
    <script>
        $$(function () {

            var force = clay.layout.force();

            // 配置
            force.config({
                center:26,//中心力强度
                coulomb:400,//库仑力缩小倍数
                spring:200,//软棒系数
                scale:0.24//组内绳子缩短程度
            });

            $$('<canvas>非常抱歉，您的浏览器不支持canvas!</canvas>')
                .appendTo('body')
                .attr('width', 720)
                .attr('height', 520);

            var layer = clay.canvas.layer('canvas', 720, 520),
                plink = layer.get('link'),
                pnode = layer.get('node');

            var colors = ['#4CAF50', '#673AB7', '#CDDC39', '#F44336', '#0a4c80', '#9E9E9E',
                '#FF9800', '#795548', '#03A9F4', '#1b290b', '#fbe209'];

            // 建立区域管理对象
            var regionManager = clay.region("canvas", 720, 520);

            plink.strokeStyle = '#ccc';
            pnode.strokeStyle = '#fff';
            plink.lineWidth = 1.5;
            pnode.lineWidth = 5;

            force
                // 分析数据方法
                .bind('analyse', function (initnode) {
                    return [initnode.id, initnode.group];
                }, function (initlink) {
                    return [initlink.source, initlink.target, initlink.value + 240];
                })
                // 绘图方法
                .bind('update', function (node) {
                    pnode.beginPath();
                    pnode.fillStyle = colors[node.orgData.group];
                    pnode.arc(node.x * 0.7 + 10, node.y * 0.5 + 10, 5, 0, Math.PI * 2);
                    pnode.stroke();
                    pnode.fill();
                    // 修改区域
                    regionManager.drawer(node.id, function (painter) {
                        painter.arc(node.x * 0.7 + 10, node.y * 0.5 + 10, 5, 0, Math.PI * 2);
                    });
                }, function (source, target, link) {
                    plink.beginPath();
                    plink.moveTo(source.x * 0.7 + 10, source.y * 0.5 + 10);
                    plink.lineTo(target.x * 0.7 + 10, target.y * 0.5 + 10);
                    plink.stroke();
                })
                .bind('live', function () {
                    layer.clean(pnode);
                    layer.clean(plink);
                    // 擦除全部区域，恢复初始化
                    regionManager.erase(function (painter) {
                        painter.fillRect(0, 0, 720, 520);
                    });
                }, function () {
                    layer.update();
                });

            force(forceData.nodes, forceData.links);

            var region = undefined, p;
            $$('canvas')
                .bind('mousedown', function (event) {
                    event = event || window.event;
                    region = regionManager.getRegion(event);
                })
                .bind('mouseup', function (event) {
                    event = event || window.event;
                    region = undefined;
                })
                .bind('mousemove', function (event) {
                    event = event || window.event;
                    if (region) {
                        p = $$('canvas').position(event);
                        force.update(region, (p.x - 10) / 7 * 10, (p.y - 10) * 2);
                        $$('canvas').css('cursor', 'pointer');
                    } else {
                        $$('canvas').css('cursor', 'default');
                    }
                });

        });
    </script>
</head>

<body></body>

</html>
